The server names that nginx will need to be a reverse proxy for are:

- www.staging.gumroad.jacquesdesmarais.dev
- app.staging.gumroad.jacquesdesmarais.dev
- www.gumroad.jacquesdesmarais.dev
- app.gumroad.jacquesdesmarais.dev

for each server name, traffic to HTTP should be automatically upgraded to HTTPS

www.staging.gumroad.jacquesdesmarais.dev should proxy to localhost port 8080
app.staging.gumroad.jacquesdesmarais.dev should proxy to localhost port 8000
www.gumroad.jacquesdesmarais.dev should proxy to localhost port 8081
app.gumroad.jacquesdesmarais.dev should proxy to localhost port 8001


# ref: https://github.com/infinityofspace/certbot_dns_porkbun?tab=readme-ov-file#docker

docker run \
   -v "/etc/letsencrypt:/etc/letsencrypt" \
   -v "/var/log/letsencrypt:/var/log/letsencrypt" \
   infinityofspace/certbot_dns_porkbun:latest \
   certonly \
     --non-interactive \
     --agree-tos \
     --email jdesma@gmail.com \
     --preferred-challenges dns \
     --authenticator dns-porkbun \
     --dns-porkbun-key pk1_9496b5d891da23881b592e4ebb01ac71783b904a4904e9d21f9878572eae8334 \
     --dns-porkbun-secret sk1_de7ae8f98a4ad333ea15c053aa7ab914678ccbfcb88762b5584bf5e0def3cfc8 \
     --dns-porkbun-propagation-seconds 60 \
      -d www.staging.gumroad.jacquesdesmarais.dev
docker run \
   -v "/etc/letsencrypt:/etc/letsencrypt" \
   -v "/var/log/letsencrypt:/var/log/letsencrypt" \
   infinityofspace/certbot_dns_porkbun:latest \
   certonly \
     --non-interactive \
     --agree-tos \
     --email jdesma@gmail.com \
     --preferred-challenges dns \
     --authenticator dns-porkbun \
     --dns-porkbun-key pk1_9496b5d891da23881b592e4ebb01ac71783b904a4904e9d21f9878572eae8334 \
     --dns-porkbun-secret sk1_de7ae8f98a4ad333ea15c053aa7ab914678ccbfcb88762b5584bf5e0def3cfc8 \
     --dns-porkbun-propagation-seconds 60 \
      -d app.staging.gumroad.jacquesdesmarais.dev
docker run \
   -v "/etc/letsencrypt:/etc/letsencrypt" \
   -v "/var/log/letsencrypt:/var/log/letsencrypt" \
   infinityofspace/certbot_dns_porkbun:latest \
   certonly \
     --non-interactive \
     --agree-tos \
     --email jdesma@gmail.com \
     --preferred-challenges dns \
     --authenticator dns-porkbun \
     --dns-porkbun-key pk1_9496b5d891da23881b592e4ebb01ac71783b904a4904e9d21f9878572eae8334 \
     --dns-porkbun-secret sk1_de7ae8f98a4ad333ea15c053aa7ab914678ccbfcb88762b5584bf5e0def3cfc8 \
     --dns-porkbun-propagation-seconds 60 \
      -d www.gumroad.jacquesdesmarais.dev
docker run \
   -v "/etc/letsencrypt:/etc/letsencrypt" \
   -v "/var/log/letsencrypt:/var/log/letsencrypt" \
   infinityofspace/certbot_dns_porkbun:latest \
   certonly \
     --non-interactive \
     --agree-tos \
     --email jdesma@gmail.com \
     --preferred-challenges dns \
     --authenticator dns-porkbun \
     --dns-porkbun-key pk1_9496b5d891da23881b592e4ebb01ac71783b904a4904e9d21f9878572eae8334 \
     --dns-porkbun-secret sk1_de7ae8f98a4ad333ea15c053aa7ab914678ccbfcb88762b5584bf5e0def3cfc8 \
     --dns-porkbun-propagation-seconds 60 \
      -d app.gumroad.jacquesdesmarais.dev


/etc/nginx/sites-available/reverse-proxy.conf


server {
    listen 80;
    server_name www.staging.gumroad.jacquesdesmarais.dev;

    location / {
        return 301 https://$host$request_uri;
    }
}

server {
    listen 80;
    server_name app.staging.gumroad.jacquesdesmarais.dev;

    location / {
        return 301 https://$host$request_uri;
    }
}

server {
    listen 80;
    server_name www.gumroad.jacquesdesmarais.dev;

    location / {
        return 301 https://$host$request_uri;
    }
}

server {
    listen 80;
    server_name app.gumroad.jacquesdesmarais.dev;

    location / {
        return 301 https://$host$request_uri;
    }
}

server {
    listen 443 ssl;
    server_name www.staging.gumroad.jacquesdesmarais.dev;

    ssl_certificate /etc/letsencrypt/archive/www.staging.gumroad.jacquesdesmarais.dev/fullchain1.pem;
    ssl_certificate_key /etc/letsencrypt/archive/www.staging.gumroad.jacquesdesmarais.dev/privkey1.pem;

    location / {
        proxy_pass http://localhost:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}

server {
    listen 443 ssl;
    server_name app.staging.gumroad.jacquesdesmarais.dev;

    ssl_certificate /etc/letsencrypt/archive/app.staging.gumroad.jacquesdesmarais.dev/fullchain1.pem;
    ssl_certificate_key /etc/letsencrypt/archive/app.staging.gumroad.jacquesdesmarais.dev/privkey1.pem;

    location / {
        proxy_pass http://localhost:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}

server {
    listen 443 ssl;
    server_name www.gumroad.jacquesdesmarais.dev;

    ssl_certificate /etc/letsencrypt/archive/www.gumroad.jacquesdesmarais.dev/fullchain1.pem;
    ssl_certificate_key /etc/letsencrypt/archive/www.gumroad.jacquesdesmarais.dev/privkey1.pem;

    location / {
        proxy_pass http://localhost:8081;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}

server {
    listen 443 ssl;
    server_name app.gumroad.jacquesdesmarais.dev;

    ssl_certificate /etc/letsencrypt/archive/app.gumroad.jacquesdesmarais.dev/fullchain1.pem;
    ssl_certificate_key /etc/letsencrypt/archive/app.gumroad.jacquesdesmarais.dev/privkey1.pem;

    location / {
        proxy_pass http://localhost:8001;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}


sudo ln -s /etc/nginx/sites-available/reverse-proxy.conf /etc/nginx/sites-enabled/

# to check syntax
sudo nginx -t

sudo systemctl reload nginx

