# https://github.com/hyperupcall/autoenv

# reloads this file
alias reload="cd $(pwd)"

alias rebuild-appserver-image="docker-compose build appserver"

alias copy-gemfiles-from-appserver="docker run --rm server_appserver bash -i -c 'cd ~/app && tar czf - Gemfile Gemfile.lock' | tar xzf -"

alias pre-up="rebuild-appserver-image && copy-gemfiles-from-appserver"

alias up="pre-up && docker-compose up -d"

alias up-sleep="pre-up && docker-compose -f docker-compose.yml -f docker-compose-sleep.yml up -d"

#
# *-* *-* *-* *-* *-* *-* *-* staging *-* *-* *-* *-* *-* *-* *-*
#

_build_staging() {
  if [ -z $RAILS_MASTER_KEY ]; then
    echo "usage: RAILS_MASTER_KEY=___________ build-staging"
    return 1
  fi
  RAILS_ENV=staging RAILS_MASTER_KEY=$RAILS_MASTER_KEY docker-compose -f docker-compose-prod.yml build appserver
}

_up_staging() {
  if [ -z $RAILS_MASTER_KEY ]; then
    echo "usage: RAILS_MASTER_KEY=___________ up-staging"
    return 1
  fi
  _build_staging && RAILS_ENV=staging RAILS_MASTER_KEY=$RAILS_MASTER_KEY docker-compose -f docker-compose-prod.yml up -d
}

alias build-staging=_build_staging

alias up-staging=_up_staging

#
# *-* *-* *-* *-* *-* *-* *-* prod *-* *-* *-* *-* *-* *-* *-*
#

_build_prod() {
  if [ -z $RAILS_MASTER_KEY ]; then
    echo "usage: RAILS_MASTER_KEY=___________ build-prod"
    return 1
  fi
  RAILS_MASTER_KEY=$RAILS_MASTER_KEY docker-compose -f docker-compose-prod.yml build appserver
}

_up_prod() {
  if [ -z $RAILS_MASTER_KEY ]; then
    echo "usage: RAILS_MASTER_KEY=___________ up-prod"
    return 1
  fi
  _build_prod && RAILS_MASTER_KEY=$RAILS_MASTER_KEY docker-compose -f docker-compose-prod.yml up -d
}

alias build-prod=_build_prod

alias up-prod=_up_prod

alias connect="docker-compose exec appserver bash"

alias connect-root="docker-compose exec --workdir /root --user root appserver bash"

# usage: get {url} {output_dir}
get() {
  local _href=$1
  local _output_dir=$2
  curl --remote-name --output-dir "$_output_dir" "$_href"
}
